<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×©×‘×¢×ª ×”××™× ×™× × ×™× ×’'×”</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            height: 100vh;
            overflow: hidden;
            touch-action: none;
            margin: 0;
            padding: 0;
            position: fixed;
            width: 100%;
        }

        .game-container {
            width: 100%;
            height: 100vh;
            position: relative;
            overflow: hidden;
        }

        .intro-screen, .level-intro-screen, .game-screen {
            position: absolute;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: linear-gradient(135deg, #FFE4B5, #F0E68C);
            padding: 20px 0;
            box-sizing: border-box;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .intro-screen h1, .level-intro-screen h1 {
            font-size: 2.2rem;
            color: #8B4513;
            margin: 10px 0 20px 0;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            text-align: center;
        }

        .intro-screen p {
            text-align: center;
            margin: 5px 20px;
            line-height: 1.3;
        }

        .fruits-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 15px;
            max-width: 600px;
            margin: 20px;
            width: 90%;
        }

        .fruit-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: rgba(255,255,255,0.8);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            user-select: none;
            min-height: 100px;
            position: relative;
            border: 2px solid transparent;
        }

        .fruit-item:hover {
            transform: scale(1.05);
        }

        .fruit-item.clicked {
            background: rgba(144,238,144,0.9);
            border: 2px solid #32CD32;
            transform: scale(1.02);
        }

        .check-mark {
            position: absolute;
            top: 5px;
            right: 5px;
            background: #32CD32;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .fruit-emoji {
            width: 64px;
            height: 64px;
            object-fit: contain;
            margin-bottom: 8px;
        }

        .target-fruit .fruit-emoji {
            width: 48px;
            height: 48px;
            object-fit: contain;
        }

        .falling-fruit .fruit-emoji {
            width: 64px;
            height: 64px;
            object-fit: contain;
        }

        .fruit-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #8B4513;
        }

        .start-button, .continue-button {
            padding: 12px 25px;
            font-size: 1.3rem;
            background: #FF6B6B;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin: 20px 20px 40px 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
            opacity: 0.6;
            width: auto;
            max-width: 90%;
            text-align: center;
        }

        .start-button:hover, .continue-button:hover {
            transform: scale(1.05);
        }

        .start-button.ready {
            background: #32CD32;
            opacity: 1;
            animation: pulse 2s infinite;
        }

        .difficulty-selector {
            margin: 20px 0;
            text-align: center;
        }

        .difficulty-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin: 15px 0;
        }

        .difficulty-btn {
            padding: 15px 20px;
            border: 3px solid #ccc;
            border-radius: 15px;
            background: rgba(255,255,255,0.9);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            font-weight: bold;
            color: #8B4513;
            text-align: center;
            min-width: 100px;
        }

        .difficulty-btn span {
            display: block;
            font-size: 0.8rem;
            margin-top: 5px;
            color: #666;
        }

        .difficulty-btn:hover {
            transform: scale(1.05);
        }

        .difficulty-btn.selected {
            border-color: #32CD32;
            background: rgba(50,205,50,0.2);
            transform: scale(1.1);
        }

        .difficulty-btn[data-difficulty="1"].selected {
            border-color: #32CD32;
            background: rgba(50,205,50,0.2);
        }

        .difficulty-btn[data-difficulty="2"].selected {
            border-color: #FFA500;
            background: rgba(255,165,0,0.2);
        }

        .difficulty-btn[data-difficulty="3"].selected {
            border-color: #FF4500;
            background: rgba(255,69,0,0.2);
        }

        .game-screen {
            background: linear-gradient(135deg, #87CEEB, #98FB98);
            overflow: hidden;
            justify-content: flex-start;
            padding: 0;
        }

        .game-header {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.95);
            padding: 8px 15px;
            border-radius: 15px;
            text-align: center;
            z-index: 100;
            max-width: 90%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .level-title {
            font-size: 1.1rem;
            color: #8B4513;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .target-fruits {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 5px;
        }

        .target-fruit {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .target-fruit .fruit-emoji {
            font-size: 1.3rem;
        }

        .target-fruit .fruit-name {
            font-size: 0.7rem;
        }

        .game-stats {
            display: flex;
            gap: 10px;
            font-size: 0.9rem;
            color: #8B4513;
            justify-content: center;
            font-weight: bold;
        }

        .falling-fruit {
            position: absolute;
            font-size: 4rem;
            cursor: crosshair;
            user-select: none;
            transition: transform 0.1s;
            z-index: 50;
            pointer-events: auto;
        }

        .falling-fruit:active {
            transform: scale(1.2);
        }

        .slice-effect {
            position: absolute;
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,0,0.8), transparent);
            pointer-events: none;
            animation: slice 0.3s ease-out;
        }

        .fruit-piece {
            position: absolute;
            font-size: 2rem;
            pointer-events: none;
            z-index: 60;
            animation: fruitFall 1s ease-in forwards;
        }

        @keyframes slice {
            0% { opacity: 1; transform: scale(0.5); }
            100% { opacity: 0; transform: scale(2); }
        }

        @keyframes fruitFall {
            0% { 
                opacity: 1; 
                transform: scale(1) rotate(0deg);
            }
            100% { 
                opacity: 0; 
                transform: scale(0.5) rotate(180deg) translateY(100px);
            }
        }

        .hidden {
            display: none !important;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @media (max-width: 768px) {
            .difficulty-buttons {
                gap: 10px;
            }
            
            .difficulty-btn {
                padding: 12px 15px;
                font-size: 1rem;
                min-width: 80px;
            }
            
            .difficulty-btn span {
                font-size: 0.7rem;
            }
        }
            .intro-screen h1, .level-intro-screen h1 {
                font-size: 1.6rem;
                margin: 5px 0 15px 0;
            }
            
            .intro-screen p {
                font-size: 1rem !important;
                margin: 3px 15px !important;
            }
            
            .fruit-emoji {
                font-size: 2.2rem;
            }
            
            .fruits-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
                margin: 10px;
                width: 95%;
                max-width: 350px;
            }
            
            .fruit-item {
                padding: 6px;
                min-height: 70px;
            }
            
            .fruit-name {
                font-size: 0.9rem;
            }
            
            .falling-fruit {
                font-size: 3rem;
            }
            
            .game-header {
                top: 5px;
                padding: 6px 12px;
                max-width: 95%;
            }
            
            .level-title {
                font-size: 0.9rem;
                margin-bottom: 3px;
            }
            
            .target-fruit .fruit-emoji {
                font-size: 1.1rem;
            }
            
            .target-fruit .fruit-name {
                font-size: 0.6rem;
            }
            
            .game-stats {
                font-size: 0.8rem;
                gap: 8px;
            }
            
            .start-button, .continue-button {
                font-size: 1.1rem;
                padding: 10px 20px;
                margin: 15px 15px 30px 15px;
                max-width: 85%;
            }
        }

        @media (max-width: 480px) {
            .intro-screen h1, .level-intro-screen h1 {
                font-size: 1.4rem;
            }
            
            .intro-screen p {
                font-size: 0.9rem !important;
            }
            
            .fruits-grid {
                gap: 6px;
                width: 98%;
            }
            
            .fruit-item {
                padding: 4px;
                min-height: 60px;
            }
            
            .fruit-emoji {
                font-size: 2rem;
            }
            
            .fruit-name {
                font-size: 0.8rem;
            }
            
            .start-button, .continue-button {
                font-size: 1rem;
                padding: 8px 16px;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- ××¡×š ×¤×ª×™×—×” -->
        <div class="intro-screen" id="introScreen">
            <h1>ğŸŒŸ ×©×‘×¢×ª ×”××™× ×™× × ×™× ×’'×” ğŸŒŸ</h1>
            <p style="font-size: 1.3rem; margin-bottom: 15px; color: #8B4513; font-weight: bold;">×œ×—×¦×• ×¢×œ ×›×œ ××—×“ ××©×‘×¢×ª ×”××™× ×™× ×›×“×™ ×œ×”×›×™×¨ ××•×ª×</p>
            <p style="font-size: 1.1rem; margin-bottom: 20px; color: #D2691E;">×œ××—×¨ ××›×Ÿ × ×•×›×œ ×œ×”×ª×—×™×œ ×œ×©×—×§!</p>
            <div class="fruits-grid">
                <div class="fruit-item" data-fruit="wheat">
                    <div class="fruit-emoji">ğŸŒ¾</div>
                    <div class="fruit-name">×—×™×˜×”</div>
                </div>
                <div class="fruit-item" data-fruit="barley">
                    <div class="fruit-emoji">ğŸŒ¿</div>
                    <div class="fruit-name">×©×¢×•×¨×”</div>
                </div>
                <div class="fruit-item" data-fruit="grape">
                    <div class="fruit-emoji">ğŸ‡</div>
                    <div class="fruit-name">×¢× ×‘×™×</div>
                </div>
                <div class="fruit-item" data-fruit="fig">
                    <img src="fig_64.png" class="fruit-emoji" alt="×ª×× ×”">
                    <div class="fruit-name">×ª×× ×”</div>
                </div>
                <div class="fruit-item" data-fruit="pomegranate">
                    <img src="pomegranate_64.png" class="fruit-emoji" alt="×¨×™××•×Ÿ">
                    <div class="fruit-name">×¨×™××•×Ÿ</div>
                </div>
                <div class="fruit-item" data-fruit="olive">
                    <img src="olive_transparent_64.png" class="fruit-emoji" alt="×–×™×ª">
                    <div class="fruit-name">×–×™×ª</div>
                </div>
                <div class="fruit-item" data-fruit="date">
                    <div class="fruit-emoji">ğŸŒ´</div>
                    <div class="fruit-name">×ª××¨</div>
                </div>
            </div>
            
            <!-- ×‘×—×™×¨×ª ×¨××ª ×§×•×©×™ -->
            <div class="difficulty-selector" id="difficultySelector" style="display: none;">
                <h2 style="color: #8B4513; margin: 20px 0 15px 0; font-size: 1.4rem;">ğŸ¯ ×‘×—×¨×• ×¨××ª ×§×•×©×™:</h2>
                <div class="difficulty-buttons">
                    <button class="difficulty-btn" data-difficulty="1">
                        ğŸŒ ××™×˜×™<br><span>×œ××ª×—×™×œ×™×</span>
                    </button>
                    <button class="difficulty-btn" data-difficulty="2">
                        ğŸš€ ×‘×™× ×•× ×™<br><span>×¨×’×™×œ</span>
                    </button>
                    <button class="difficulty-btn" data-difficulty="3">
                        âš¡ ××”×™×¨<br><span>××ª×§×“××™×</span>
                    </button>
                </div>
            </div>
            
            <button class="start-button" id="startGameBtn" style="display: none;">×œ×—×¦×• ×¢×œ ×›×œ ×”××™× ×™× ×›×“×™ ×œ×”×ª×—×™×œ</button>
        </div>

        <!-- ××¡×š ×”×¦×’×ª ×©×œ×‘ -->
        <div class="level-intro-screen hidden" id="levelIntroScreen">
            <h1 id="levelIntroTitle">×©×œ×‘ 1</h1>
            <p style="font-size: 1.3rem; margin-bottom: 20px; color: #8B4513;">×—×ª×›×• ××ª ×”××™× ×™× ×”×‘××™×:</p>
            <div class="fruits-grid" id="levelIntroFruits">
                <!-- ×™×™×•×•×¡×£ ×“×™× ××™×ª -->
            </div>
            <button class="continue-button" id="continueBtn">×”××©×š ×œ×©×œ×‘!</button>
        </div>

        <!-- ××¡×š ×”××©×—×§ -->
        <div class="game-screen hidden" id="gameScreen">
            <div class="game-header">
                <div class="level-title" id="currentLevelTitle">×©×œ×‘ 1 - ×—×ª×›×•:</div>
                <div class="target-fruits" id="targetFruitsDisplay">
                    <!-- ×™×™×•×•×¡×£ ×“×™× ××™×ª -->
                </div>
                <div class="game-stats">
                    <span>× ×§×•×“×•×ª: <span id="score">0</span></span>
                    <span>×™×¢×“: <span id="target">5</span></span>
                    <span>×—×™×™×: <span id="lives">â¤ï¸â¤ï¸â¤ï¸</span></span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ××©×ª× ×™ ××©×—×§
        const fruits = {
            wheat: { emoji: 'ğŸŒ¾', name: '×—×™×˜×”', points: 10 },
            barley: { emoji: 'ğŸŒ¿', name: '×©×¢×•×¨×”', points: 10 },
            grape: { emoji: 'ğŸ‡', name: '×¢× ×‘×™×', points: 15 },
            fig: { emoji: 'ğŸˆ', name: '×ª×× ×”', points: 15 },
            pomegranate: { emoji: 'ğŸ', name: '×¨×™××•×Ÿ', points: 20 },
            olive: { emoji: 'ğŸ«’', name: '×–×™×ª', points: 20 },
            date: { emoji: 'ğŸŒ´', name: '×ª××¨', points: 25 }
        };

        const DISTRACTORS = {
            apple: { emoji: 'ğŸ', name: '×ª×¤×•×—' },
            banana: { emoji: 'ğŸŒ', name: '×‘× × ×”' },
            carrot: { emoji: 'ğŸ¥•', name: '×’×–×¨' },
            strawberry: { emoji: 'ğŸ“', name: '×ª×•×ª' }
        };

        const LEVELS = [
            { 
                title: '×©×œ×‘ 1 - ×—×ª×›×•:', 
                targets: ['wheat', 'barley'],
                description: '×—×™×˜×” ×•×©×¢×•×¨×”'
            },
            { 
                title: '×©×œ×‘ 2 - ×—×ª×›×•:', 
                targets: ['grape', 'fig'],
                description: '×¢× ×‘×™× ×•×ª×× ×™×'
            },
            { 
                title: '×©×œ×‘ 3 - ×—×ª×›×•:', 
                targets: ['olive', 'date', 'pomegranate'],
                description: '×–×™×ª×™×, ×ª××¨×™× ×•×¨×™××•× ×™×'
            }
        ];

        let currentLevel = 0;
        let score = 0;
        let lives = 3;
        let correctCuts = 0;
        let gameActive = false;
        let fallingFruits = [];
        let spawnRate = 2000;
        let gameInterval;
        let spawnInterval;
        let clickedFruits = new Set();
        let baseSpeed, randSpeed;

        // ××œ×× ×˜×™×
        const introScreen = document.getElementById('introScreen');
        const levelIntroScreen = document.getElementById('levelIntroScreen');
        const gameScreen = document.getElementById('gameScreen');
        const startGameBtn = document.getElementById('startGameBtn');
        const continueBtn = document.getElementById('continueBtn');

        // ×”×§×¨××ª ×©××•×ª ×‘×¤×ª×™×—×”
        document.querySelectorAll('.fruit-item').forEach(item => {
            item.addEventListener('click', () => {
                const fruitKey = item.dataset.fruit;
                const fruitName = fruits[fruitKey].name;
                speak(fruitName);
                
                // ×”×•×¡×¤×ª ××™× ×“×™×§×¦×™×” ×©× ×œ×—×¥
                if (!item.classList.contains('clicked')) {
                    item.classList.add('clicked');
                    
                    // ×”×•×¡×¤×ª V
                    const checkMark = document.createElement('div');
                    checkMark.className = 'check-mark';
                    checkMark.textContent = 'âœ“';
                    item.appendChild(checkMark);
                    
                    clickedFruits.add(fruitKey);
                }
                
                // ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨
                updateStartButton();
            });
        });

        function updateStartButton() {
            const startBtn = document.getElementById('startGameBtn');
            const difficultySelector = document.getElementById('difficultySelector');
            
            startBtn.style.display = 'block';
            
            if (clickedFruits.size === 7) {
                difficultySelector.style.display = 'block';
                startBtn.classList.add('ready');
                startBtn.textContent = 'ğŸ® ×”×ª×—×™×œ×• ×œ×©×—×§! ğŸ®';
                startBtn.style.cursor = 'pointer';
            } else {
                difficultySelector.style.display = 'none';
                startBtn.classList.remove('ready');
                const remaining = 7 - clickedFruits.size;
                startBtn.textContent = `×¢×•×“ ${remaining} ××™× ×™× ×œ×¤× ×™ ×©××ª×—×™×œ×™×...`;
                startBtn.style.cursor = 'not-allowed';
            }
        }

        // ×‘×—×™×¨×ª ×¨××ª ×§×•×©×™
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                // ×”×¡×¨×ª ×‘×—×™×¨×” ×§×•×“××ª
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('selected'));
                
                // ×‘×—×™×¨×” ×—×“×©×”
                btn.classList.add('selected');
                currentDifficulty = parseInt(btn.dataset.difficulty);
                
                console.log('Selected difficulty:', currentDifficulty);
            });
        });

        // ×‘×—×™×¨×ª ×¨××” 1 ×›×‘×¨×™×¨×ª ××—×“×œ
        document.querySelector('.difficulty-btn[data-difficulty="1"]').classList.add('selected');

        // ×”×ª×—×œ×ª ××©×—×§
        startGameBtn.addEventListener('click', () => {
            if (clickedFruits.size === 7) {
                showLevelIntro();
            } else {
                const remaining = 7 - clickedFruits.size;
                alert(`×¢×“×™×™×Ÿ ×¦×¨×™×š ×œ×œ×—×•×¥ ×¢×œ ${remaining} ××™× ×™× × ×•×¡×¤×™×!`);
            }
        });

        continueBtn.addEventListener('click', startLevel);

        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'he-IL';
                utterance.rate = 0.8;
                speechSynthesis.speak(utterance);
            }
        }

        function showLevelIntro() {
            introScreen.classList.add('hidden');
            levelIntroScreen.classList.remove('hidden');
            
            const level = LEVELS[currentLevel];
            document.getElementById('levelIntroTitle').textContent = `×©×œ×‘ ${currentLevel + 1}`;
            
            const fruitsContainer = document.getElementById('levelIntroFruits');
            fruitsContainer.innerHTML = '';
            
            level.targets.forEach(fruitKey => {
                const fruit = fruits[fruitKey];
                const fruitDiv = document.createElement('div');
                fruitDiv.className = 'fruit-item';
                if (fruitKey === 'fig' || fruitKey === 'pomegranate' || fruitKey === 'olive') {
                    const imgSrc = fruitKey === 'olive' ? 'olive_transparent_64.png' : `${fruitKey}_64.png`;
                    fruitDiv.innerHTML = `
                        <img src="${imgSrc}" class="fruit-emoji" alt="${fruit.name}">
                        <div class="fruit-name">${fruit.name}</div>
                    `;
                } else {
                    fruitDiv.innerHTML = `
                        <div class="fruit-emoji">${fruit.emoji}</div>
                        <div class="fruit-name">${fruit.name}</div>
                    `;
                }
                fruitDiv.addEventListener('click', () => {
                    speak(fruit.name);
                    fruitDiv.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        fruitDiv.style.transform = 'scale(1)';
                    }, 200);
                });
                fruitsContainer.appendChild(fruitDiv);
            });
        }

        function startLevel() {
            levelIntroScreen.classList.add('hidden');
            gameScreen.classList.remove('hidden');
            
            // ××™×¤×•×¡ ××©×ª× ×™×
            correctCuts = 0;
            lives = 3;
            gameActive = true;
            
            updateUI();
            initSliceEvents(); // ×”×¤×¢×œ×ª ××™×¨×•×¢×™ ×—×™×ª×•×š
            startGameLoop();
            
            console.log('Game started - slice events initialized'); // ×“×™×‘×•×’
        }

        function updateUI() {
            const level = LEVELS[currentLevel];
            document.getElementById('currentLevelTitle').textContent = level.title;
            document.getElementById('score').textContent = score;
            document.getElementById('lives').textContent = `â¤ï¸ ${lives}`;
            
            const targetDisplay = document.getElementById('targetFruitsDisplay');
            targetDisplay.innerHTML = '';
            
            level.targets.forEach(fruitKey => {
                const fruit = fruits[fruitKey];
                const targetDiv = document.createElement('div');
                targetDiv.className = 'target-fruit';
                if (fruitKey === 'fig' || fruitKey === 'pomegranate' || fruitKey === 'olive') {
                    const imgSrc = fruitKey === 'olive' ? 'olive_transparent_64.png' : `${fruitKey}_64.png`;
                    targetDiv.innerHTML = `
                        <img src="${imgSrc}" class="fruit-emoji" alt="${fruit.name}">
                        <div class="fruit-name">${fruit.name}</div>
                    `;
                } else {
                    targetDiv.innerHTML = `
                        <div class="fruit-emoji">${fruit.emoji}</div>
                        <div class="fruit-name">${fruit.name}</div>
                    `;
                }
                targetDisplay.appendChild(targetDiv);
            });
        }

        function startGameLoop() {
            spawnInterval = setInterval(spawnFruit, spawnRate);
            gameInterval = setInterval(updateGame, 50);
        }

        function spawnFruit() {
            if (!gameActive) return;
            
            const level = LEVELS[currentLevel];
            const allFruits = [...level.targets, ...Object.keys(DISTRACTORS)];
            const randomFruit = allFruits[Math.floor(Math.random() * allFruits.length)];
            
            let fruit, isTarget;
            if (level.targets.includes(randomFruit)) {
                fruit = fruits[randomFruit];
                isTarget = true;
            } else {
                fruit = DISTRACTORS[randomFruit];
                isTarget = false;
            }
            
            const fruitElement = document.createElement('div');
            fruitElement.className = 'falling-fruit';
            
            if (randomFruit === 'fig' || randomFruit === 'pomegranate' || randomFruit === 'olive') {
                const imgSrc = randomFruit === 'olive' ? 'olive_transparent_64.png' : `${randomFruit}_64.png`;
                fruitElement.innerHTML = `<img src="${imgSrc}" class="fruit-emoji" alt="${fruit.name}">`;
            } else {
                fruitElement.innerHTML = `<div class="fruit-emoji">${fruit.emoji}</div>`;
            }
            
            fruitElement.style.left = Math.random() * (window.innerWidth - 80) + 'px';
            fruitElement.style.top = '-80px';
            fruitElement.dataset.isTarget = isTarget;
            fruitElement.dataset.fruitKey = randomFruit;
            
            fruitElement.style.pointerEvents = 'auto';
            
            if (typeof currentDifficulty === 'undefined' || currentDifficulty === 1) {
                baseSpeed = 2;
                randSpeed = 3;
            } else if (currentDifficulty === 2) {
                baseSpeed = 5;
                randSpeed = 3;
            } else if (currentDifficulty === 3) {
                baseSpeed = 11;
                randSpeed = 5;
            }
            fallingFruits.push({
                element: fruitElement,
                y: -80,
                speed: baseSpeed + Math.random() * randSpeed
            });
            
            gameScreen.appendChild(fruitElement);
        }

        let isSlicing = false;
        let lastSliceTime = 0;
        let sliceEventsInitialized = false;

        // ××™×¨×•×¢×™ ×—×™×ª×•×š ×’×œ×•×‘×œ×™×™×
        function initSliceEvents() {
            if (sliceEventsInitialized) return;
            sliceEventsInitialized = true;
            
            // ××™×¨×•×¢×™ ×¢×›×‘×¨
            gameScreen.addEventListener('mousedown', startSlice);
            document.addEventListener('mousemove', handleSlice);
            document.addEventListener('mouseup', endSlice);
            
            // ××™×¨×•×¢×™ ××’×¢
            gameScreen.addEventListener('touchstart', startSlice, { passive: false });
            document.addEventListener('touchmove', handleSlice, { passive: false });
            document.addEventListener('touchend', endSlice);
        }

        function startSlice(e) {
            if (!gameActive) return;
            e.preventDefault();
            isSlicing = true;
            handleSlice(e);
        }

        function handleSlice(e) {
            if (!isSlicing || !gameActive) return;
            
            const currentTime = Date.now();
            if (currentTime - lastSliceTime < 50) return;
            lastSliceTime = currentTime;
            
            let x, y;
            if (e.type.includes('touch')) {
                if (e.touches && e.touches[0]) {
                    x = e.touches[0].clientX;
                    y = e.touches[0].clientY;
                }
            } else {
                x = e.clientX;
                y = e.clientY;
            }
            
            if (!x || !y) return;
            
            // ×—×™×¤×•×© ×¤×™×¨×•×ª ×‘× ×§×•×“×ª ×”×—×™×ª×•×š
            const elements = document.elementsFromPoint(x, y);
            const fruitElement = elements.find(el => el.classList.contains('falling-fruit'));
            
            if (fruitElement && !fruitElement.dataset.cut) {
                cutFruit(fruitElement, x, y);
                fruitElement.dataset.cut = 'true';
            }
        }

        function endSlice(e) {
            isSlicing = false;
        }

        function cutFruit(fruitElement, x, y) {
            const isTarget = fruitElement.dataset.isTarget === 'true';
            const fruitKey = fruitElement.dataset.fruitKey;
            
            // ×™×¦×™×¨×ª ×—×œ×§×™ ×¤×¨×™
            createFruitPieces(fruitElement, fruitKey);
            
            // ××¤×§×˜ ×—×™×ª×•×š
            createSliceEffect(x, y);
            
            if (isTarget) {
                score += fruits[fruitKey].points;
                correctCuts++;
                
                if (correctCuts >= 5) {
                    levelComplete();
                }
            } else {
                lives--;
                if (lives <= 0) {
                    gameOver();
                }
            }
            
            // ×”×¡×¨×ª ×”×¤×¨×™
            fruitElement.remove();
            fallingFruits = fallingFruits.filter(f => f.element !== fruitElement);
            
            updateUI();
        }

        function createFruitPieces(fruitElement, fruitKey) {
            const rect = fruitElement.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            // ×™×¦×™×¨×ª 3-4 ×—×œ×§×™×
            const numPieces = 3 + Math.floor(Math.random() * 2);
            
            for (let i = 0; i < numPieces; i++) {
                const piece = document.createElement('div');
                piece.className = 'fruit-piece';
                
                // ×‘×—×™×¨×ª ×ª×¦×•×’×” ×œ×—×œ×§
                if (fruitKey === 'fig' || fruitKey === 'pomegranate' || fruitKey === 'olive') {
                    const imgSrc = fruitKey === 'olive' ? 'olive_transparent_64.png' : `${fruitKey}_64.png`;
                    piece.innerHTML = `<img src="${imgSrc}" class="fruit-emoji" alt="${fruits[fruitKey].name}">`;
                } else {
                    piece.innerHTML = `<div class="fruit-emoji">${fruits[fruitKey].emoji}</div>`;
                }
                
                piece.style.left = centerX + 'px';
                piece.style.top = centerY + 'px';
                
                // ×›×™×•×•×Ÿ ××§×¨××™ ×œ×›×œ ×—×œ×§
                const angle = (360 / numPieces) * i + Math.random() * 60;
                const distance = 50 + Math.random() * 50;
                const endX = centerX + Math.cos(angle * Math.PI / 180) * distance;
                const endY = centerY + Math.sin(angle * Math.PI / 180) * distance + 100;
                
                piece.style.setProperty('--endX', endX + 'px');
                piece.style.setProperty('--endY', endY + 'px');
                
                // ×¢×“×›×•×Ÿ ×”×× ×™××¦×™×” ×¢× ×”×›×™×•×•×Ÿ ×”×—×“×©
                piece.style.animation = `fruitFall${i} 1s ease-in forwards`;
                
                // ×™×¦×™×¨×ª ×× ×™××¦×™×” ×“×™× ××™×ª
                const keyframes = `
                    @keyframes fruitFall${i} {
                        0% { 
                            opacity: 1; 
                            transform: scale(1) rotate(0deg);
                            left: ${centerX}px;
                            top: ${centerY}px;
                        }
                        100% { 
                            opacity: 0; 
                            transform: scale(0.3) rotate(${180 + Math.random() * 180}deg);
                            left: ${endX}px;
                            top: ${endY}px;
                        }
                    }
                `;
                
                // ×”×•×¡×¤×ª ×”×× ×™××¦×™×” ×œ×¢××•×“
                const style = document.createElement('style');
                style.textContent = keyframes;
                document.head.appendChild(style);
                
                gameScreen.appendChild(piece);
                
                // ×”×¡×¨×ª ×”×—×œ×§ ××—×¨×™ ×”×× ×™××¦×™×”
                setTimeout(() => {
                    piece.remove();
                    style.remove();
                }, 1000);
            }
        }

        function createSliceEffect(x, y) {
            const effect = document.createElement('div');
            effect.className = 'slice-effect';
            effect.style.left = (x - 50) + 'px';
            effect.style.top = (y - 50) + 'px';
            gameScreen.appendChild(effect);
            
            setTimeout(() => effect.remove(), 300);
        }

        function updateGame() {
            if (!gameActive) return;
            
            fallingFruits.forEach((fruit, index) => {
                fruit.y += fruit.speed;
                fruit.element.style.top = fruit.y + 'px';
                
                if (fruit.y > window.innerHeight) {
                    fruit.element.remove();
                    fallingFruits.splice(index, 1);
                }
            });
        }

        function levelComplete() {
            gameActive = false;
            clearInterval(gameInterval);
            clearInterval(spawnInterval);
            
            // × ×™×§×•×™ ×¤×™×¨×•×ª × ×•×¤×œ×™×
            fallingFruits.forEach(fruit => fruit.element.remove());
            fallingFruits = [];
            
            // ×”×•×“×¢×ª ×”×¦×œ×—×”
            alert(`×›×œ ×”×›×‘×•×“! ×¡×™×™××ª× ××ª ×©×œ×‘ ${currentLevel + 1}!`);
            
            currentLevel++;
            
            if (currentLevel >= LEVELS.length) {
                gameWin();
            } else {
                // ××¢×‘×¨ ×œ××¡×š ×‘×™× ×™×™× ×©×œ ×”×©×œ×‘ ×”×‘×
                gameScreen.classList.add('hidden');
                showLevelIntro();
            }
        }

        function gameOver() {
            gameActive = false;
            clearInterval(gameInterval);
            clearInterval(spawnInterval);
            
            // × ×™×§×•×™ ×¤×™×¨×•×ª × ×•×¤×œ×™×
            fallingFruits.forEach(fruit => fruit.element.remove());
            fallingFruits = [];
            
            alert('×”××©×—×§ × ×’××¨! ×ª×ª×—×™×œ×• ××—×“×©');
            
            // ××™×¤×•×¡ ×œ××©×—×§ ××—×“×©
            currentLevel = 0;
            score = 0;
            lives = 3;
            correctCuts = 0;
            
            gameScreen.classList.add('hidden');
            showLevelIntro();
        }

        function gameWin() {
            alert('×›×œ ×”×›×‘×•×“! ×¡×™×™××ª× ××ª ×›×œ ×”×©×œ×‘×™×!\n×œ××“×ª× ××ª ×©×‘×¢×ª ×”××™× ×™×!');
            
            // ××™×¤×•×¡ ×œ××©×—×§ ××—×“×©
            currentLevel = 0;
            score = 0;
            lives = 3;
            correctCuts = 0;
            clickedFruits.clear();
            
            // ××™×¤×•×¡ ××¡×š ×”×¤×ª×™×—×”
            document.querySelectorAll('.fruit-item').forEach(item => {
                item.classList.remove('clicked');
                const checkMark = item.querySelector('.check-mark');
                if (checkMark) {
                    checkMark.remove();
                }
            });
            
            gameScreen.classList.add('hidden');
            levelIntroScreen.classList.add('hidden');
            introScreen.classList.remove('hidden');
            
            updateStartButton();
        }

        // ×× ×™×¢×ª ×”×ª× ×”×’×•×ª ×‘×¨×™×¨×ª ××—×“×œ
        document.addEventListener('touchmove', function(e) {
            if (gameActive) e.preventDefault();
        }, { passive: false });
        
        document.addEventListener('touchstart', function(e) {
            if (gameActive) e.preventDefault();
        }, { passive: false });

        // ×× ×™×¢×ª ×–×•× ×‘××•×‘×™×™×œ
        document.addEventListener('gesturestart', function(e) {
            e.preventDefault();
        });

        // ×”×ª×××ª ×’×•×‘×” ×œ×“×¤×“×¤× ×™× ××•×‘×™×™×œ
        function setViewportHeight() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }

        window.addEventListener('resize', setViewportHeight);
        window.addEventListener('orientationchange', setViewportHeight);
        setViewportHeight();
    </script>
</body>
</html>